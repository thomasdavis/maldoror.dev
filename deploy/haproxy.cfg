global
    maxconn 4096
    log stdout format raw local0

defaults
    mode tcp
    timeout connect 10s
    timeout client 1h
    timeout server 1h
    log global
    option tcplog

frontend ssh_frontend
    bind *:22
    default_backend ssh_servers

    # Enable TCP keepalive on client side
    option clitcpka

backend ssh_servers
    balance roundrobin
    option tcp-check

    # Queue connections when all backends are down (during restart)
    timeout queue 30s

    # Health check - verify SSH banner
    tcp-check connect
    tcp-check expect string SSH

    # Graceful server drain - wait for connections to finish
    default-server inter 3s fall 2 rise 2 on-marked-down shutdown-sessions

    server ssh1 ssh-world:2222 check

# Stats interface for monitoring
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
